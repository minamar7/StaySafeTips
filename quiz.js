window.QuizEngine = {
  content: {
    el: {
      "badge-home": [
        /* LEVEL 1 (Î•Î¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ ÏƒÏ„Î¿ Level 1 Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·) */
        {
          q: "Î•Î¯Î½Î±Î¹ Î±ÏƒÏ†Î±Î»Î­Ï‚ Î½Î± Î±Ï†Î®Î½ÎµÎ¹Ï‚ Ï„Î¿ ÎºÎ»ÎµÎ¹Î´Î¯ ÎºÎ¬Ï„Ï‰ Î±Ï€ÏŒ Ï„Î¿ Ï‡Î±Î»Î¬ÎºÎ¹;",
          options: ["ÎÎ±Î¹", "ÎŒÏ‡Î¹", "ÎœÏŒÎ½Î¿ Î±Î½ Î»ÎµÎ¯Ï€Ï‰ Î»Î¯Î³Î¿"],
          correct: 1,
          explain: "ÎŸÎ¹ Î´Î¹Î±ÏÏÎ®ÎºÏ„ÎµÏ‚ ÎµÎ»Î­Î³Ï‡Î¿Ï…Î½ Ï€ÏÏÏ„Î± Ï‡Î±Î»Î¬ÎºÎ¹Î± ÎºÎ±Î¹ Î³Î»Î¬ÏƒÏ„ÏÎµÏ‚."
        },
        {
          q: "Î¤Î¹ ÎºÎ¬Î½Î¿Ï…Î¼Îµ Î±Î½ Î¼Ï…ÏÎ¯ÏƒÎµÎ¹ Ï…Î³ÏÎ±Î­ÏÎ¹Î¿ ÏƒÏ„Î¿ ÏƒÏ€Î¯Ï„Î¹;",
          options: ["Î‘Î½Î¬Î²Î¿Ï…Î¼Îµ Ï†Ï‰Ï‚", "Î‘Î½Î¿Î¯Î³Î¿Ï…Î¼Îµ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ±", "ÎšÎ±Î»Î¿ÏÎ¼Îµ Ï„Î·Î½ Î±ÏƒÏ„Ï…Î½Î¿Î¼Î¯Î±"],
          correct: 1,
          explain: "Î”ÎµÎ½ Î±Î³Î³Î¯Î¶Î¿Ï…Î¼Îµ Î´Î¹Î±ÎºÏŒÏ€Ï„ÎµÏ‚. Î‘ÎµÏÎ¯Î¶Î¿Ï…Î¼Îµ Î¬Î¼ÎµÏƒÎ± Ï„Î¿Î½ Ï‡ÏÏÎ¿."
        },
        {
          q: "Î ÏŒÏƒÎ¿ ÏƒÏ…Ï‡Î½Î¬ ÎµÎ»Î­Î³Ï‡Î¿Ï…Î¼Îµ Ï„Î¿Î½ Î±Î½Î¹Ï‡Î½ÎµÏ…Ï„Î® ÎºÎ±Ï€Î½Î¿Ï;",
          options: ["ÎšÎ¬Î¸Îµ Ï‡ÏÏŒÎ½Î¿", "Î Î¿Ï„Î­", "ÎšÎ¬Î¸Îµ Î¼Î®Î½Î±"],
          correct: 2,
          explain: "ÎŸ Î¼Î·Î½Î¹Î±Î¯Î¿Ï‚ Î­Î»ÎµÎ³Ï‡Î¿Ï‚ ÏƒÏÎ¶ÎµÎ¹ Î¶Ï‰Î­Ï‚."
        },
        /* LEVEL 2 (ÎÎµÎºÎ»ÎµÎ¹Î´ÏÎ½Î¿Ï…Î½ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± ÏŒÏ„Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï€Î¬ÎµÎ¹ Level 2) */
        {
          q: "Î¤Î¹ ÎºÎ¬Î½Î¿Ï…Î¼Îµ Î±Î½ Ï€Î¹Î¬ÏƒÎµÎ¹ Ï†Ï‰Ï„Î¹Î¬ Ï„Î¿ Ï„Î·Î³Î¬Î½Î¹ Î¼Îµ Î»Î¬Î´Î¹;",
          options: ["Î¡Î¯Ï‡Î½Î¿Ï…Î¼Îµ Î½ÎµÏÏŒ", "Î£ÎºÎµÏ€Î¬Î¶Î¿Ï…Î¼Îµ Î¼Îµ ÎºÎ±Ï€Î¬ÎºÎ¹", "Î¦Ï…ÏƒÎ¬Î¼Îµ Ï„Î· Ï†Ï‰Ï„Î¹Î¬"],
          correct: 1,
          explain: "Î¤Î¿ Î½ÎµÏÏŒ Ï€ÏÎ¿ÎºÎ±Î»ÎµÎ¯ Î­ÎºÏÎ·Î¾Î· ÏƒÏ„Î¿ ÎºÎ±Ï…Ï„ÏŒ Î»Î¬Î´Î¹. ÎšÎ»ÎµÎ¯ÏƒÏ„Îµ Ï„Î¿ Î¿Î¾Ï…Î³ÏŒÎ½Î¿ Î¼Îµ ÎºÎ±Ï€Î¬ÎºÎ¹."
        },
        {
          q: "Î Î¿Î¹Î± ÎµÎ¯Î½Î±Î¹ Î· ÎºÎ±Î»ÏÏ„ÎµÏÎ· Î¸Î­ÏƒÎ· Î³Î¹Î± Î­Î½Î± Ï‡ÏÎ·Î¼Î±Ï„Î¿ÎºÎ¹Î²ÏÏ„Î¹Î¿;",
          options: ["Î Î¯ÏƒÏ‰ Î±Ï€ÏŒ Ï€Î¯Î½Î±ÎºÎ±", "Î’Î¹Î´Ï‰Î¼Î­Î½Î¿ ÏƒÏ„Î¿ Ï€Î¬Ï„Ï‰Î¼Î±", "ÎœÎ­ÏƒÎ± ÏƒÏ„Î·Î½ Î½Ï„Î¿Ï…Î»Î¬Ï€Î±"],
          correct: 1,
          explain: "Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î±Î¸ÎµÏÎ¬ ÏƒÏ„ÎµÏÎµÏ‰Î¼Î­Î½Î¿ Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎºÎ»Î±Ï€ÎµÎ¯ Î¿Î»ÏŒÎºÎ»Î·ÏÎ¿."
        },
        {
          q: "Î ÏÏ‚ Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎ¿Ï…Î¼Îµ Ï„Î¿ ÏƒÏ€Î¯Ï„Î¹ ÏŒÏ„Î±Î½ Î»ÎµÎ¯Ï€Î¿Ï…Î¼Îµ Î¼Î­ÏÎµÏ‚;",
          options: ["ÎšÎ»ÎµÎ¯Î½Î¿Ï…Î¼Îµ ÏŒÎ»Î± Ï„Î± Ï†ÏÏ„Î±", "Î§ÏÎ¿Î½Î¿Î´Î¹Î±ÎºÏŒÏ€Ï„Î·Ï‚ Ï†ÏÏ„Ï‰Î½", "ÎšÎ»ÎµÎ¹Î´Î¯ ÏƒÏ„Î· Î³Î»Î¬ÏƒÏ„ÏÎ±"],
          correct: 1,
          explain: "ÎˆÎ½Î± ÏƒÏ€Î¯Ï„Î¹ Ï€Î¿Ï… Ï†Î±Î¯Î½ÎµÏ„Î±Î¹ ÎºÎ±Ï„Î¿Î¹ÎºÎ·Î¼Î­Î½Î¿ Î±Ï€Î¿Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î¿Ï…Ï‚ Î´Î¹Î±ÏÏÎ®ÎºÏ„ÎµÏ‚."
        }
      ],
      "badge-digital": [
        {
          q: "Î•Î¯Î½Î±Î¹ Î±ÏƒÏ†Î±Î»Î­Ï‚ Î½Î± Î´Î¯Î½ÎµÎ¹Ï‚ ÎºÏ‰Î´Î¹ÎºÎ¿ÏÏ‚ Î¼Î­ÏƒÏ‰ email;",
          options: ["ÎÎ±Î¹", "ÎŒÏ‡Î¹", "ÎœÏŒÎ½Î¿ ÏƒÏ„Î·Î½ Ï„ÏÎ¬Ï€ÎµÎ¶Î±"],
          correct: 1,
          explain: "ÎšÎ±Î¼Î¯Î± Ï…Ï€Î·ÏÎµÏƒÎ¯Î± Î´ÎµÎ½ Î¶Î·Ï„Î¬ ÎºÏ‰Î´Î¹ÎºÎ¿ÏÏ‚ Î¼Î­ÏƒÏ‰ email."
        },
        {
          q: "Î¤Î¹ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ 2FA;",
          options: ["Î”Î¹Ï€Î»ÏŒÏ‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚", "Î”ÎµÏÏ„ÎµÏÎ¿ Î²Î®Î¼Î± Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚", "Î•Ï†Î±ÏÎ¼Î¿Î³Î® chat"],
          correct: 1,
          explain: "Î ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ Î­Î½Î± ÎµÏ€Î¹Ï€Î»Î­Î¿Î½ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ Ï€ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î±Ï‚."
        }
      ],
      "quiz": [
        {
          q: "Î Î¿Î¹Î± ÎµÎ¯Î½Î±Î¹ Î· Ï€Î¹Î¿ Î±ÏƒÏ†Î±Î»Î®Ï‚ Î¼Î­Î¸Î¿Î´Î¿Ï‚ ÎºÎ»ÎµÎ¹Î´ÏÎ¼Î±Ï„Î¿Ï‚ ÎºÎ¹Î½Î·Ï„Î¿Ï;",
          options: ["PIN 4 ÏˆÎ·Ï†Î¯Ï‰Î½", "ÎœÎ¿Ï„Î¯Î²Î¿", "Î’Î¹Î¿Î¼ÎµÏ„ÏÎ¹ÎºÎ¬ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±"],
          correct: 2,
          explain: "Î¤Î± Î²Î¹Î¿Î¼ÎµÏ„ÏÎ¹ÎºÎ¬ ÎµÎ¯Î½Î±Î¹ Î´Ï…ÏƒÎºÎ¿Î»ÏŒÏ„ÎµÏÎ¿ Î½Î± Ï€Î±ÏÎ±Î²Î¹Î±ÏƒÏ„Î¿ÏÎ½."
        }
      ]
    },

    en: {
      "quiz": [
        {
          q: "What is the most secure phone lock method?",
          options: ["4-digit PIN", "Pattern", "Biometrics"],
          correct: 2,
          explain: "Biometrics are harder to bypass."
        }
      ]
    }
  },

  difficulty: {
    "badge-home": 1,
    "badge-digital": 1.2,
    "badge-scam": 1.5,
    "badge-emergency": 1.3,
    "quiz": 1
  },

  activeQuestions: [],
  currentIndex: 0,
  score: 0,
  streak: 0,
  badge: "",
  currentLang: "el",

  start(lang = "el", badgeId = "quiz") {
    this.currentLang = lang;
    this.badge = badgeId;

    // 1. Î›Î®ÏˆÎ· ÎµÏ€Î¹Ï€Î­Î´Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· ÎºÎ±Î¹ ÎµÏÏ‰Ï„Î®ÏƒÎµÏ‰Î½ Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ Î®Î´Î· Î±Ï€Î±Î½Ï„Î·Î¸ÎµÎ¯ (Mastered)
    const userLvl = parseInt(document.getElementById("user-level")?.textContent) || 1;
    const mastered = JSON.parse(localStorage.getItem(`mastered_${badgeId}`) || "[]");
    const allPool = this.content[lang][badgeId] || this.content[lang]["quiz"];

    // 2. ÎˆÎ¾Ï…Ï€Î½Î¿ Ï†Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î±: Leveling (Î±Î½Î¬ 3Î¬Î´Î±) + ÎœÎ½Î®Î¼Î·
    let available = allPool.filter((qData, index) => {
      const isNew = !mastered.includes(qData.q);
      const qLevel = Math.floor(index / 3) + 1;
      return isNew && qLevel <= userLvl;
    });

    // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î½Î­ÎµÏ‚ ÎµÏÏ‰Ï„Î®ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï„Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿, Î´ÎµÎ¯Î¾Îµ ÏŒÎ»Î¿ Ï„Î¿ pool Î¼Î­Ï‡ÏÎ¹ Ï„Î¿ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î·
    if (available.length === 0) {
      available = allPool.filter((_, index) => (Math.floor(index / 3) + 1) <= userLvl);
    }

    // 3. Î¤Ï…Ï‡Î±Î¯Î± ÎµÏ€Î¹Î»Î¿Î³Î® 3 ÎµÏÏ‰Ï„Î®ÏƒÎµÏ‰Î½
    this.activeQuestions = [...available]
      .sort(() => Math.random() - 0.5)
      .slice(0, 3);

    this.currentIndex = 0;
    this.score = 0;
    this.streak = 0;

    const res = document.getElementById("quiz-result");
    if (res) {
      res.classList.add("hidden");
      res.style.display = "none";
    }

    this.render();
  },

  render() {
    const qData = this.activeQuestions[this.currentIndex];
    const qBox = document.getElementById("quiz-question");
    const oBox = document.getElementById("quiz-options");
    const pill = document.getElementById("quiz-pill");

    if (pill) {
      pill.textContent =
        (this.currentLang === "el" ? "Î•ÏÏÏ„Î·ÏƒÎ·" : "Question") +
        ` ${this.currentIndex + 1} / ${this.activeQuestions.length}`;
    }

    if (qBox) {
      qBox.innerHTML = `
        <p class="q-text" style="font-size:1.2rem;font-weight:bold;text-align:center;">
          ${qData.q}
        </p>
      `;
    }

    if (oBox) {
      oBox.innerHTML = "";
      qData.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt;
        btn.onclick = () => this.check(idx);
        oBox.appendChild(btn);
      });
    }
  },

  check(idx) {
    const qData = this.activeQuestions[this.currentIndex];
    const buttons = document.querySelectorAll(".option-btn");

    buttons.forEach((b, i) => {
      b.disabled = true;
      if (i === qData.correct) b.classList.add("correct");
      if (i === idx && idx !== qData.correct) b.classList.add("wrong");
    });

    if (idx === qData.correct) {
      this.score++;
      this.streak++;
      
      // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î± Mastered
      let mastered = JSON.parse(localStorage.getItem(`mastered_${this.badge}`) || "[]");
      if (!mastered.includes(qData.q)) {
        mastered.push(qData.q);
        localStorage.setItem(`mastered_${this.badge}`, JSON.stringify(mastered));
      }

      if (this.streak >= 3) this.updateXP(20);
    } else {
      this.streak = 0;
    }

    if (qData.explain) {
      const qBox = document.getElementById("quiz-question");
      qBox.innerHTML += `<p class="explain" style="color:var(--gold); font-size:0.95rem; margin-top:10px;">ğŸ’¡ ${qData.explain}</p>`;
    }

    setTimeout(() => {
      this.currentIndex++;
      this.currentIndex < this.activeQuestions.length
        ? this.render()
        : this.showResult();
    }, 1200);
  },

  showResult() {
    const res = document.getElementById("quiz-result");
    const scoreText = document.getElementById("quiz-result-score");
    const percent = Math.round(
      (this.score / this.activeQuestions.length) * 100
    );

    if (res) {
      res.classList.remove("hidden");
      res.style.display = "flex";
    }

    if (scoreText) {
      scoreText.textContent =
        (this.currentLang === "el" ? "Î£ÎºÎ¿Ï" : "Score") + `: ${percent}%`;
    }

    if (percent >= 60) {
      const xp = 50 * (this.difficulty[this.badge] || 1);
      this.updateXP(Math.round(xp));
      if (this.badge.startsWith("badge-")) this.unlockBadge(this.badge);
    }

    const btn = document.getElementById("quiz-result-continue");
    if (btn) btn.onclick = () => window.showScreen?.("home");
  },

  updateXP(amount) {
    const xpFill = document.getElementById("xp-fill");
    const lv = document.getElementById("user-level");
    if (!xpFill || !lv) return;

    let currentWidth = parseFloat(xpFill.style.width) || 0;
    let newWidth = currentWidth + (amount / 5);

    if (newWidth >= 100) {
      lv.textContent = parseInt(lv.textContent) + 1;
      xpFill.style.width = (newWidth - 100) + "%"; // ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬ Ï…Ï€Î¿Î»Î¿Î¯Ï€Î¿Ï…
    } else {
      xpFill.style.width = newWidth + "%";
    }
  },

  unlockBadge(id) {
    const el = document.getElementById(id);
    if (!el || !el.classList.contains("locked")) return;

    el.classList.remove("locked");
    el.classList.add("unlocked");

    const saved = JSON.parse(localStorage.getItem("ss_badges") || "[]");
    if (!saved.includes(id)) {
      saved.push(id);
      localStorage.setItem("ss_badges", JSON.stringify(saved));
    }
  }
};
